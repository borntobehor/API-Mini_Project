<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Article</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="../scss/bootstrap.css">
    <style>
        .quill-editor {
            min-height: 220px;
            border: 1px solid #e9ecef;
            border-top: none;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="text-primary fw-bold">Create Article</h2>
        <p class="text-muted">Compose a new article and publish it to your platform.</p>

        <div class="card shadow-sm">
            <div class="card-body">
                <form id="FormData" class="mb-0">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title *</label>
                        <input id="title" name="title" type="text" class="form-control"
                            placeholder="Title of the article" required>
                    </div>

                    <div class="mb-3">
                        <label for="category" class="form-label">Category *</label>
                        <select id="category" name="category" class="form-select" required>
                            <option value="">Select category</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="thumbnail" class="form-label">Thumbnail *</label>
                        <input id="thumbnail" name="thumbnail" type="file" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content *</label>
                        <div id="quillToolbar">
                            <span class="ql-formats">
                                <select class="ql-font"></select>
                                <select class="ql-size"></select>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-bold"></button>
                                <button class="ql-italic"></button>
                                <button class="ql-underline"></button>
                                <button class="ql-blockquote"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-code-block"></button>
                                <button class="ql-link"></button>
                                <button class="ql-image"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-list" value="ordered"></button>
                                <button class="ql-list" value="bullet"></button>
                                <select class="ql-align"></select>
                            </span>
                        </div>
                        <div id="quillEditor" class="quill-editor"></div>
                        <input type="hidden" id="content" name="content">
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <a href="../index.html" class="text-decoration-none">‚Üê Back to Articles</a>
                        <button type="submit" class="btn btn-primary">Publish Now</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        let category_id = document.querySelector("#category");

        const baseUrlCategory =
            "http://blogs.csm.linkpc.net/api/v1/categories?_page=1&_per_page=10&sortBy=name&sortDir=ASC";

        fetch(baseUrlCategory, {
            method: "GET",
        })
            .then((res) => res.json())
            .then((res) => {
                console.log(res);
                res.data.items.forEach((cat) => {
                    let option = document.createElement("option");
                    option.value = cat.id;
                    option.textContent = cat.name;
                    category_id.appendChild(option);
                });
            });

        let form = document.querySelector("#FormData");
        let title = document.querySelector("#title");
        let thumbnail = document.querySelector("#thumbnail");
        let content = document.querySelector("#content");
        const baseUrl = "http://blogs.csm.linkpc.net/api/v1";
        // let token = localStorage.getItem("token")
        let token =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjk3NywiaWF0IjoxNzY3MDY3Nzk5LCJleHAiOjE3Njc2NzI1OTl9.gx8_a2NqWmkM4Jh9TXLvIrIhJ3soHrqO3fRtwqV2RSw";
        // const baseUrl = "http://articles.csm.linkpc.net";

        let quill = new Quill("#quillEditor", {
            modules: {
                toolbar: "#quillToolbar",
            },
            theme: "snow",
        });

        form.onsubmit = (event) => {
            event.preventDefault();

            let contentHTML = quill.root.innerHTML.trim();
            const catId = parseInt(category_id.value, 10);

            fetch(baseUrl + "/articles", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    title: title.value.trim(),
                    categoryId: catId,
                    content: contentHTML,
                }),
            })
                .then((res) => res.json())
                .then((res) => {
                    console.log("Create article success:", res);

                    const articleId = res.data?.id;
                    if (!articleId) {
                        alert("Article ID not returned");
                        return;
                    }

                    let formData = new FormData();
                    formData.append("thumbnail", thumbnail.files[0]);

                    return fetch(`${baseUrl}/articles/${articleId}/thumbnail`, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                        body: formData,
                    });
                })
                .then((res) => res.json())
                .then(() => {
                location.href = "../profile/profile.html";
                });


        };
    </script>

</body>

</html>