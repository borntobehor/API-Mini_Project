<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile</title>

<link rel="stylesheet" href="../scss/bootstrap.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
body{background:#f5f7fa;font-family:Arial,Helvetica,sans-serif;}
.card{border-radius:12px;border:none;box-shadow:0 4px 10px rgba(0,0,0,.05);}
.article-card{transition:.2s;}
.article-card:hover{transform:translateY(-3px);}
.card-img-top{height:180px;object-fit:cover;}
.quill-editor{min-height:200px;border:1px solid #e9ecef;border-top:none;}
</style>
</head>

<body>

<script>
const token = localStorage.getItem("token");
if(!token) location.href="login.html";
</script>

<div class="container mt-4 col-md-8">

<h4 class="text-center mb-3">My Profile</h4>

<div class="card mb-4 text-center p-3">
    <img id="avatar" class="rounded-circle mx-auto mb-2" style="width:80px;height:80px">
    <h5 id="name"></h5>
    <small id="lastName" class="text-muted"></small>
</div>

<div class="text-end mb-3">
    <button class="btn btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="fa fa-plus"></i>
    </button>
</div>

<div class="row" id="articleList"></div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal">
<div class="modal-dialog modal-lg modal-dialog-centered">
<div class="modal-content">

<div class="modal-header">
    <h5>Create Article</h5>
    <button class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
<form id="createForm">

<input id="title" class="form-control mb-2" placeholder="Title" required>

<select id="category" class="form-select mb-2" required>
    <option value="">Select category</option>
</select>

<div id="quillToolbar">
  <button class="ql-bold"></button>
  <button class="ql-italic"></button>
  <button class="ql-underline"></button>
</div>
<div id="quillEditor" class="quill-editor mb-2"></div>

<button class="btn btn-primary w-100">Publish</button>

</form>
</div>

</div>
</div>
</div>

</div>

<script src="../js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
const baseURL = "http://blogs.csm.linkpc.net/api/v1";

const nameEl = document.getElementById("name");
const lastNameEl = document.getElementById("lastName");
const avatarEl = document.getElementById("avatar");
const articleList = document.getElementById("articleList");
const categorySelect = document.getElementById("category");

const quill = new Quill('#quillEditor',{
    theme:'snow',
    modules:{toolbar:'#quillToolbar'}
});

/* LOAD PROFILE */
fetch(`${baseURL}/auth/profile`,{
    headers:{Authorization:`Bearer ${token}`}
})
.then(r=>r.json())
.then(res=>{
    nameEl.textContent = res.data.firstName;
    lastNameEl.textContent = res.data.lastName;
    avatarEl.src = res.data.avatar || "https://via.placeholder.com/80";
});

/* LOAD CATEGORIES */
fetch(`${baseURL}/categories?_page=1&_per_page=20`,{
    headers:{Authorization:`Bearer ${token}`}
})
.then(r=>r.json())
.then(res=>{
    res.data.items.forEach(c=>{
        let opt=document.createElement("option");
        opt.value=c.id;
        opt.textContent=c.name;
        categorySelect.appendChild(opt);
    });
});

/* ðŸ”¥ LOAD ONLY MY ARTICLES (CRITICAL FIX) */
function loadArticles(){
fetch(`${baseURL}/articles`,{
    headers:{Authorization:`Bearer ${token}`}
})
.then(r=>r.json())
.then(res=>{
    if(!res.data || !res.data.length){
        articleList.innerHTML="<p class='text-center text-muted'>No articles yet</p>";
        return;
    }

    articleList.innerHTML = res.data.map(a=>`
    <div class="col-md-4 mb-4">
        <div class="card article-card">
            <img src="${a.thumbnail||'https://via.placeholder.com/300x180'}" class="card-img-top">
            <div class="card-body">
                <h5 class="card-title">${a.title}</h5>
                <p class="card-text text-truncate">
                    ${a.content.replace(/<[^>]+>/g,'').substring(0,100)}...
                </p>
                <a href="../article.html?id=${a.id}" class="btn btn-primary btn-sm">
                    Read More
                </a>
            </div>
        </div>
    </div>
    `).join("");
});
}
loadArticles();

/* CREATE ARTICLE */
document.getElementById("createForm").onsubmit = e =>{
e.preventDefault();

const title = document.getElementById("title").value.trim();
const categoryId = Number(categorySelect.value);
const content = quill.root.innerHTML.trim();

if(!title || !categoryId || content.replace(/<[^>]+>/g,'').length < 10){
    alert("Fill all fields (content â‰¥ 10 chars)");
    return;
}

fetch(`${baseURL}/articles`,{
    method:"POST",
    headers:{
        Authorization:`Bearer ${token}`,
        "Content-Type":"application/json"
    },
    body:JSON.stringify({title, categoryId, content})
})
.then(r=>r.json())
.then(res=>{
    if(!res.result){
        alert(JSON.stringify(res.details));
        return;
    }

    bootstrap.Modal.getInstance(document.getElementById("createModal")).hide();
    loadArticles();
});
};
</script>

</body>
</html>
