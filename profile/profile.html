<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Profile</title>

   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
   <link rel="stylesheet" href="../scss/bootstrap.css">

   <style>
      body {
         background: #f5f7fa;
         font-family: Arial, Helvetica, sans-serif;
      }

      .card {
         border-radius: 12px;
         border: none;
         box-shadow: 0 4px 10px rgba(0, 0, 0, .05);
      }

      .article-card {
         transition: .2s;
      }

      .article-card:hover {
         transform: translateY(-3px);
      }

      .card-img-top {
         height: 180px;
         object-fit: cover;
      }

      .create-wrapper {
         position: relative;
         display: inline-block;
      }

      .create-popup {
         position: absolute;
         right: 0;
         top: 45px;
         background: #fff;
         padding: 8px 12px;
         border-radius: 8px;
         box-shadow: 0 5px 15px rgba(0, 0, 0, .15);
         font-size: 13px;
         white-space: nowrap;
         display: none;
      }

      .create-wrapper:hover .create-popup {
         display: block;
      }
   </style>
</head>

<body>

   <script>
      const token = localStorage.getItem("token");
      if (!token) location.href = "../auth/login.html";
   </script>

   <div class="container mt-4 col-md-6">

      <h4 class="mb-3 text-center">My Profile</h4>

      <div class="card mb-4 d-flex align-items-center p-3">
         <img id="avatar" class="rounded-circle mb-2" style="width:80px;height:80px">
         <div class="text-center">
            <h5 id="name" class="mb-0"></h5>
            <small id="lastName" class="text-muted"></small>
         </div>
      </div>

      <div class="d-flex justify-content-end mb-3">
         <div class="create-wrapper">
            <button class="btn btn-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#createModal">
               <i class="fa-solid fa-plus"></i>
            </button>
            <div class="create-popup">Create Article</div>
         </div>
      </div>

      <div class="row" id="articleList"></div>

      <div class="modal fade" id="createModal" tabindex="-1">
         <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

               <div class="modal-header">
                  <h5 class="modal-title">Create Article</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
               </div>

               <div class="modal-body p-0">
                  <iframe src="create.html" style="width:100%;height:520px;border:none"></iframe>
               </div>

            </div>
         </div>
      </div>

   </div>

   <script src="../js/bootstrap.bundle.min.js"></script>

   <script>
      const baseURL = "http://blogs.csm.linkpc.net/api/v1";

      const nameEl = document.getElementById("name");
      const lastNameEl = document.getElementById("lastName");
      const avatarEl = document.getElementById("avatar");
      const articleList = document.getElementById("articleList");

      fetch(`${baseURL}/auth/profile`, {
         headers: { Authorization: `Bearer ${token}` }
      })
         .then(res => res.json())
         .then(res => {
            nameEl.textContent = res.data.firstName;
            lastNameEl.textContent = res.data.lastName;
            avatarEl.src = res.data.avatar || "https://via.placeholder.com/80";
         })
         .catch(() => location.href = "login.html");

      function loadArticles() {
         fetch(`${baseURL}/articles/my`, {
            headers: { Authorization: `Bearer ${token}` }
         })
            .then(res => res.json())
            .then(res => {
               if (!res.data || !res.data.length) {
                  articleList.innerHTML =
                     "<p class='text-center text-muted'>No articles yet</p>";
                  return;
               }

               let html = "";
               res.data.forEach(a => {
                  html += `
            <div class="col-12 mb-3">
                <div class="card article-card">
                    ${a.image ? `<img src="${a.image}" class="card-img-top">` : ""}
                    <div class="card-body">
                        <h6 class="card-title">${a.title}</h6>
                        <p class="card-text text-muted mb-1">
                            ${a.category?.name || "No category"}
                        </p>
                        <small class="text-muted">
                            ${new Date(a.createdAt).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            </div>`;
               });
               articleList.innerHTML = html;
            });
      }
      loadArticles();

      window.addEventListener("message", e => {
         if (e.data === "ARTICLE_CREATED") {
            bootstrap.Modal.getInstance(document.getElementById("createModal")).hide();
            loadArticles();
         }
      });
   </script>

</body>

</html>